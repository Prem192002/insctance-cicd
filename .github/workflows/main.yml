name: EC2 FastAPI Deployment

on:
  push:
    branches:
      - main
      - stage
      - develop

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > ec2_key.pem
          chmod 400 ec2_key.pem

      - name: Deploy FastAPI to EC2 with folder mapping
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          ssh -o StrictHostKeyChecking=no -i ec2_key.pem ec2-user@$EC2_HOST <<'EOF'
            set -ex

            # Map GitHub branch to EC2 folder
            case "$BRANCH_NAME" in
              main)
                FOLDER_NAME="main"
                ;;
              stage)
                FOLDER_NAME="stage"
                ;;
              develop)
                FOLDER_NAME="develop"
                ;;
              *)
                echo " Unknown branch: $BRANCH_NAME"
                exit 1
                ;;
            esac

            # Define target path
            BASE_DIR="/home/ec2-user"
            TARGET_DIR="$BASE_DIR/$FOLDER_NAME/insctance-cicd"

            echo " Navigating to $TARGET_DIR"
            cd $TARGET_DIR

            echo " Cleaning local changes"
            git reset --hard
            git clean -fd

            echo " Fetching latest code from $BRANCH_NAME"
            git fetch origin
            git checkout $BRANCH_NAME
            git reset --hard origin/$BRANCH_NAME

            echo " Installing dependencies"
            pip3 install --user -r instance-code/process-calling/requirements.txt

            echo " Running FastAPI app"
            chmod +x instance-code/process-calling/run_process.sh
            ./instance-code/process-calling/run_process.sh

            echo " Deployment completed for $BRANCH_NAME"
          EOF
